# CTQA Hook Notifier

## About

This utility responds to events generated by the hooks within [CTQA](https://github.com/Brikwerk/ctqa/wiki/Setting-Up-Notifications) and broadcasts them as emails. Four types of events are broadcast:

+ Daily Reports Generated
+ Weekly Reports Generated
+ Warnings of Impending CT Machine drift
+ CT Machine Failure

Each of these events are sent with the relevant metadata and reports attached.

*Please Note:* This notifier only supports sending notifications through a GMail account. Please feel free to extend the functionality on your own or submit a pull request. See the "Extending Functionality" section for more details.

## Prerequisites

+ Windows XP or greater
+ Python 3.5 or greater
+ GMail API Credentials
    + This can be generated [here](https://developers.google.com/gmail/api/quickstart/python) by clicking the "Enable the GMail API" button and following the instructions until you are able to download the JSON file.

## Installing

1. Clone the repo to your desired location.

2. Copy your GMail credentials into the root of the project.

3. Run setup.bat from your terminal (please review it beforehand!) and fill in the relevant information. If you're using a GMail account, you will be prompted for access. Make sure to click "Advanced" and "Allow" when the "Unverified App" screen pops up.

4. If you'd like, you can send a test email when authentication completes.

5. Within CTQA's notifications panel, you can now paste the path to the "email.bat" file within this project.

## Extending Functionality

The "run.py" file is currently the main entry point for this project. Usage of the GMail API within this file can simply be replaced with your desired functionality.

Example:

```python
# Weekly
elif notificationtype == "weekly":
    # Getting recipients
    with open("recipients_weekly.txt") as f:
        RECIPIENTS = f.read().replace("\n", ", ")

    subject = "CTQA: Weekly Reports"
    body = "%d weekly report(s) from the CTQA utility are attached.\nDate/time Run: %s" % (len(data), str(datetime.datetime.now()))
    
    #################################################################################
    # Replace this line with your function for sending a notification
    gmailapi.email(SENDER, RECIPIENTS, subject, body, attachments=data)
    #################################################################################
```

## Testing

The /test directory contains a (poorly drawn) example graph and test runners for the different types of events. All test runners reference the graph and should result in an email with the test graph attached when run.
